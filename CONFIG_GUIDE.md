# WebSocket API é…ç½®æŒ‡å—

## è¶…æ—¶é…ç½®è¯´æ˜

ç°åœ¨å¯ä»¥é€šè¿‡ `config.json` æ–‡ä»¶é…ç½® WebSocket æœåŠ¡å™¨çš„è¶…æ—¶å‚æ•°ï¼Œå®ç°æ›´çµæ´»çš„è¿æ¥ç®¡ç†ã€‚

### é…ç½®é¡¹è¯´æ˜

æ‰€æœ‰è¶…æ—¶æ—¶é—´å•ä½å‡ä¸º**ç§’**ã€‚

#### åŸºç¡€é…ç½®

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `ws_port` | 8080 | WebSocket æœåŠ¡å™¨ç›‘å¬ç«¯å£ |
| `max_connections` | 100 | æœ€å¤§å¹¶å‘è¿æ¥æ•° |

#### è¶…æ—¶é…ç½®

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `handshake_timeout` | 10 | WebSocket æ¡æ‰‹è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `message_timeout` | 30 | API è¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `heartbeat_interval` | 30 | å¿ƒè·³å‘é€é—´éš”ï¼ˆç§’ï¼‰ |
| `idle_timeout` | 300 | è¿æ¥ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤5åˆ†é’Ÿï¼‰ |

### é…ç½®ç¤ºä¾‹

```json
{
  "username": "your_username",
  "password": "your_password",
  "ws_port": 8080,
  "check": false,
  "device_id": "",
  "hardware": "",
  
  "_comment_timeout": "WebSocket è¶…æ—¶é…ç½®ï¼ˆå•ä½ï¼šç§’ï¼‰",
  "max_connections": 100,
  "handshake_timeout": 10,
  "message_timeout": 30,
  "heartbeat_interval": 30,
  "idle_timeout": 300,
  
  "keywords": ["è¯·é—®", "è¯·å¸®æˆ‘"],
  "initial_interval": 1.0,
  "min_interval": 0.2,
  "max_interval": 3.0,
  "fetch_limit": 1,
  "block_xiaoai_response": true
}
```

### é…ç½®è°ƒä¼˜å»ºè®®

#### 1. ç¨³å®šçš„å†…ç½‘ç¯å¢ƒ
å¦‚æœæœåŠ¡å™¨åœ¨ç¨³å®šçš„å†…ç½‘ç¯å¢ƒä¸­è¿è¡Œï¼š
```json
{
  "heartbeat_interval": 60,
  "idle_timeout": 600
}
```
- å‡å°‘å¿ƒè·³é¢‘ç‡ï¼Œé™ä½ç½‘ç»œå¼€é”€
- å»¶é•¿ç©ºé—²è¶…æ—¶ï¼Œæ”¯æŒæ›´é•¿æ—¶é—´çš„é™é»˜è¿æ¥

#### 2. ä¸ç¨³å®šçš„ç½‘ç»œç¯å¢ƒ
å¦‚æœç½‘ç»œç¯å¢ƒä¸ç¨³å®šæˆ–é€šè¿‡å…¬ç½‘è®¿é—®ï¼š
```json
{
  "heartbeat_interval": 15,
  "idle_timeout": 120
}
```
- å¢åŠ å¿ƒè·³é¢‘ç‡ï¼ŒåŠæ—¶æ£€æµ‹è¿æ¥çŠ¶æ€
- ç¼©çŸ­ç©ºé—²è¶…æ—¶ï¼Œå¿«é€Ÿé‡Šæ”¾å¤±æ•ˆè¿æ¥

#### 3. é«˜å¹¶å‘åœºæ™¯
å¦‚æœéœ€è¦æ”¯æŒå¤§é‡å¹¶å‘è¿æ¥ï¼š
```json
{
  "max_connections": 500,
  "handshake_timeout": 5,
  "message_timeout": 20
}
```
- æé«˜æœ€å¤§è¿æ¥æ•°
- ç¼©çŸ­æ¡æ‰‹å’Œå¤„ç†è¶…æ—¶ï¼ŒåŠ å¿«è¿æ¥å‘¨è½¬

#### 4. é•¿æ—¶é—´ä¿æŒè¿æ¥
å¦‚æœå®¢æˆ·ç«¯éœ€è¦é•¿æ—¶é—´ä¿æŒè¿æ¥ï¼ˆå¦‚ç›‘æ§é¢æ¿ï¼‰ï¼š
```json
{
  "heartbeat_interval": 45,
  "idle_timeout": 1800
}
```
- é€‚ä¸­çš„å¿ƒè·³é—´éš”
- å»¶é•¿ç©ºé—²è¶…æ—¶åˆ°30åˆ†é’Ÿ

### å„é…ç½®é¡¹è¯¦ç»†è¯´æ˜

#### max_connections
- **ä½œç”¨**ï¼šé™åˆ¶æœåŠ¡å™¨åŒæ—¶å¤„ç†çš„æœ€å¤§è¿æ¥æ•°
- **å½±å“**ï¼šè¶…è¿‡æ­¤æ•°é‡çš„æ–°è¿æ¥å°†è¢«æ‹’ç»
- **å»ºè®®**ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½å’Œé¢„æœŸè´Ÿè½½è®¾ç½®

#### handshake_timeout
- **ä½œç”¨**ï¼šWebSocket æ¡æ‰‹é˜¶æ®µçš„è¶…æ—¶æ—¶é—´
- **å½±å“**ï¼šæ¡æ‰‹å¤±è´¥çš„è¿æ¥ä¼šå¿«é€Ÿé‡Šæ”¾èµ„æº
- **å»ºè®®**ï¼šé€šå¸¸ 5-10 ç§’å³å¯ï¼Œä¸å®œè¿‡é•¿

#### message_timeout
- **ä½œç”¨**ï¼šå•ä¸ª API è¯·æ±‚çš„å¤„ç†è¶…æ—¶æ—¶é—´
- **å½±å“**ï¼šè¶…æ—¶çš„è¯·æ±‚ä¼šè¿”å›é”™è¯¯ï¼Œä½†ä¸ä¼šæ–­å¼€è¿æ¥
- **å»ºè®®**ï¼šæ ¹æ® API å“åº”æ—¶é—´è®¾ç½®ï¼Œé€šå¸¸ 20-60 ç§’

#### heartbeat_interval
- **ä½œç”¨**ï¼šæœåŠ¡å™¨ä¸»åŠ¨å‘é€å¿ƒè·³ ping çš„é—´éš”
- **å½±å“**ï¼šå¯åŠæ—¶æ£€æµ‹å¤±æ•ˆè¿æ¥ï¼Œä½†è¿‡äºé¢‘ç¹ä¼šå¢åŠ ç½‘ç»œå¼€é”€
- **å»ºè®®**ï¼šç¨³å®šç¯å¢ƒ 30-60 ç§’ï¼Œä¸ç¨³å®šç¯å¢ƒ 15-30 ç§’

#### idle_timeout
- **ä½œç”¨**ï¼šè¿æ¥æ— æ¶ˆæ¯äº¤äº’çš„æœ€é•¿ç­‰å¾…æ—¶é—´
- **å½±å“**ï¼šè¶…æ—¶åä¼šå…ˆå‘é€ ping æ£€æŸ¥ï¼Œæ— å“åº”æ‰æ–­å¼€è¿æ¥
- **å»ºè®®**ï¼šä¸€èˆ¬è®¾ä¸ºå¿ƒè·³é—´éš”çš„ 5-10 å€

### ç›‘æ§ä¸è°ƒè¯•

å¯åŠ¨æœåŠ¡å™¨æ—¶ä¼šæ˜¾ç¤ºå½“å‰é…ç½®ï¼š

```
ğŸš€ WebSocket æœåŠ¡å™¨å·²å¯åŠ¨
ç›‘å¬åœ°å€: ws://0.0.0.0:8080
æœ€å¤§è¿æ¥æ•°: 100
æ¡æ‰‹è¶…æ—¶: 10s
æ¶ˆæ¯å¤„ç†è¶…æ—¶: 30s
å¿ƒè·³é—´éš”: 30s
ç©ºé—²è¶…æ—¶: 300s
æŒ‰ Ctrl+C åœæ­¢æœåŠ¡
```

### æ•…éšœæ’æŸ¥

#### é—®é¢˜ï¼šè¿æ¥é¢‘ç¹æ–­å¼€
**å¯èƒ½åŸå› **ï¼š`idle_timeout` æˆ– `heartbeat_interval` è®¾ç½®è¿‡çŸ­
**è§£å†³æ–¹æ¡ˆ**ï¼š
```json
{
  "heartbeat_interval": 60,
  "idle_timeout": 600
}
```

#### é—®é¢˜ï¼šå®¢æˆ·ç«¯è¯·æ±‚è¶…æ—¶
**å¯èƒ½åŸå› **ï¼š`message_timeout` è®¾ç½®è¿‡çŸ­
**è§£å†³æ–¹æ¡ˆ**ï¼š
```json
{
  "message_timeout": 60
}
```

#### é—®é¢˜ï¼šæ— æ³•å»ºç«‹æ–°è¿æ¥
**å¯èƒ½åŸå› **ï¼šè¾¾åˆ° `max_connections` é™åˆ¶
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¢åŠ  `max_connections`
- æ£€æŸ¥æ˜¯å¦æœ‰åƒµå°¸è¿æ¥ï¼Œè°ƒæ•´ `idle_timeout`

### æ³¨æ„äº‹é¡¹

1. **é…ç½®ä¿®æ”¹éœ€é‡å¯**ï¼šä¿®æ”¹é…ç½®åéœ€è¦é‡å¯ WebSocket æœåŠ¡å™¨æ‰èƒ½ç”Ÿæ•ˆ
2. **å•ä½ä¸€è‡´æ€§**ï¼šæ‰€æœ‰è¶…æ—¶æ—¶é—´å‡ä¸ºç§’ï¼Œæ— éœ€è½¬æ¢
3. **å…¼å®¹æ€§**ï¼šé…ç½®æ–‡ä»¶å‘åå…¼å®¹ï¼Œæœªè®¾ç½®çš„é¡¹å°†ä½¿ç”¨é»˜è®¤å€¼
4. **JSON æ ¼å¼**ï¼šæ³¨é‡Šå­—æ®µï¼ˆå¦‚ `_comment_timeout`ï¼‰ä¼šè¢«å¿½ç•¥ï¼Œä»…ç”¨äºè¯´æ˜

### å¸¸è§åœºæ™¯æ¨èé…ç½®

#### å¼€å‘æµ‹è¯•ç¯å¢ƒ
```json
{
  "max_connections": 50,
  "handshake_timeout": 10,
  "message_timeout": 60,
  "heartbeat_interval": 30,
  "idle_timeout": 300
}
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆç¨³å®šå†…ç½‘ï¼‰
```json
{
  "max_connections": 200,
  "handshake_timeout": 5,
  "message_timeout": 30,
  "heartbeat_interval": 60,
  "idle_timeout": 600
}
```

#### å…¬ç½‘éƒ¨ç½²
```json
{
  "max_connections": 100,
  "handshake_timeout": 10,
  "message_timeout": 30,
  "heartbeat_interval": 20,
  "idle_timeout": 180
}
```

#### é«˜å¯é æ€§è¦æ±‚
```json
{
  "max_connections": 150,
  "handshake_timeout": 8,
  "message_timeout": 45,
  "heartbeat_interval": 15,
  "idle_timeout": 120
}
```

## ä½¿ç”¨æ–¹æ³•

1. ç¼–è¾‘ `config.json` æ–‡ä»¶
2. æ ¹æ®éœ€æ±‚è°ƒæ•´è¶…æ—¶é…ç½®
3. å¯åŠ¨ WebSocket API æœåŠ¡å™¨ï¼š
   ```bash
   cargo run -p miai-cli -- wsapi
   ```
4. è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤é…ç½®å·²ç”Ÿæ•ˆ
